# esp-now-relay

This is platform.io project for esp8266 device.

## Background

This is one part of home automation project which can control relay(s) over
* esp-now message from paired device (remote control)
* esp-now message from mqtt<->esp-now bridge

## Included components
* __esp-now-relay__ - controls relay to open gate or do another action (this repo)
* esp-now-relay-remote - battery powered ESP32-C6 device to control relay e.g. from car
* esp-now-gw-mqtt - mqtt<->esp-now bridge - wifi and mqtt part
* esp-now-gw-transmitter - mqtt<->esp-now bridge - esp-now part

## Supported esp-now messages

All messages are (application) encrypted and are null terminated strings with json content.

### Relay control
Several relays can be controlled, this code version controls 2 of them.

```json
{
    "channel": 1,
    "state": 1,
    "push": 300,
    "from": "MQTT-GW",
    "battery": 89
}
```
* `channel` is relay index - 1 or 2 for 2 relays
* `state` can controll whether relay is connected (1) or released (0)
* `push` simulates press of button, connects relay for given number of miliseconds
* `from` identifies sender of the message. Can be mqtt gateway or paired remote
* `battery` battery level for remotes (or any battery powered device)

`State` and `push` can't be used together, only one of them can be provided.

### Pairing
Any remote control can be paired dynamically so mac address are not hardcoded in the code. There are several messages involved in pairing.

#### Initiate pairing
```json
{
    "pairMs": 10000,
    "channel": 1
}
```
This message turns pairing mode on. Only in pairing mode requests from remote devices are accepted. This message can be received only from mqtt gateway (mac address is verified).

#### Pairing request
This message is sent from remote device and is accepted only in pairing mode.
```json
{
    "pairMagic": 12345,
    "id": 54321,
    "from": "REMOTE-1",
    "counter": 1
}
```
* `pairMagic` is constant number - must match value given here in config.h
* `id` is random number generated by requestor (remote) and is used in pairing reply
* `from` short text decription identifying device. Is used in summary to be able to unpair one device by message from mqtt gw
* `counter` current rolling code value used by remote

#### Pairing response
This is simple response from this device indicating that pairing was successful and providing paired (my) mac address to requestor. Having real mac address remote will send addressed messages to control relays - commpared to broadcast message used for pairing request.
```json
{
    "pairMagic": 12345,
    "id": 54321,
    "from": "RELAY-1",
    "channel": 1
}
```
* `pairMagic` is same constant as for request
* `id` matching id generated by requestor. This is how remote indentifies response to its pairing request
* `from` my identification - used just for debug logging on remote side
* `channel` show to which relay channel client was paired. This number will be sent in push requests

#### Pairing list
This message can arrive only from mqtt gateway (mac check) and in response list of all paired devices is sent back to gateway.
Because of esp-now message size limit the paired clients are sent one by one with delay 100ms between each.

```json
{
    "pairMagic": 12345,
    "action": "list",
}
```

Response message looks like
```json
{
    "log": "Paired client",
    "client": {
        "name": "REMOTE-1",
        "counter": 1,
        "index": 0,
        "channel": 0
    }
}
```

#### Clear pairing
This message can arrive only from mqtt gateway (mac check) and deletes pairing for one or all devices.
```json
{
    "pairMagic": 12345,
    "action": "unpair",
    "index": 1
}
```
* `index` is optional, when not provided, all clients are ereased
* note when client "in the middle" is unpaired the following clients are renumbered - their index is decreased


### OTA
As relay device is usually mounted somewhere outdoors it's convenient to be able to release new code via OTA. The problem is device is connected via esp-now, not wifi. There's dedivated message to switch to wifi connection and enable OTA upload.

```json
{
    "otaMs": 30000
}
```
Such message disconnects esp-now, tries to connect to wifi (with credentials given in config.h) and stays connected to wifi for given number of miliseconds. After this time device restarts back to esp-now listen state. The IP address given by DHCP during wifi connection is recorded and sent during normal boot to esp-now gw via "alive message".